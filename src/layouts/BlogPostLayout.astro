---
import BaseLayout from "@/layouts/BaseLayout.astro";
import Newsletter from "@/components/Newsletter.astro";
import TableOfContents from "@/components/TableOfContents.astro";
import Webmentions from "@/components/Webmentions.astro";
import SeriesBanner from "@/components/SeriesBanner.astro";
import SeriesNav from "@/components/SeriesNav.astro";
import type { SeriesInfo } from "@/utils/series";
import SummarizeButton from "@/components/vue/SummarizeButton.vue";

interface Props {
  title: string;
  description: string;
  pubDate: Date;
  updatedDate?: Date;
  author: string;
  tags: string[];
  ogImage?: string;
  headings: Array<{
    depth: number;
    slug: string;
    text: string;
  }>;
  readingTime: number;
  pageViews?: number;
  references?: Array<{
    title?: string;
    url?: string;
    description?: string;
  }>;
  relatedPosts?: Array<{
    slug: string;
    data: {
      title: string;
      description: string;
    };
  }>;
  seriesInfo?: SeriesInfo | null;
  markdownUrl?: string;
}

var {
  title,
  description,
  pubDate,
  updatedDate,
  author,
  tags,
  ogImage,
  headings,
  readingTime,
  pageViews,
  references,
  relatedPosts,
  seriesInfo,
  markdownUrl,
} = Astro.props;

var formattedPubDate = new Intl.DateTimeFormat("en-US", {
  year: "numeric",
  month: "long",
  day: "numeric",
}).format(pubDate);

var formattedUpdatedDate = updatedDate
  ? new Intl.DateTimeFormat("en-US", {
      year: "numeric",
      month: "long",
      day: "numeric",
    }).format(updatedDate)
  : null;

var canonicalURL = new URL(Astro.url.pathname, Astro.site);
var fullURL = canonicalURL.toString();
---

<BaseLayout
  title={title}
  description={description}
  ogImage={ogImage}
  markdownUrl={markdownUrl}
>
  <script
    slot="head"
    src="https://giscus.app/client.js"
    data-repo="meysam81/meysam81"
    data-repo-id="R_kgDOG8F82Q"
    data-category="General"
    data-category-id="DIC_kwDOG8F82c4CxAK5"
    data-mapping="pathname"
    data-strict="0"
    data-reactions-enabled="1"
    data-emit-metadata="0"
    data-input-position="bottom"
    data-theme="dark_high_contrast"
    data-lang="en"
    data-loading="lazy"
    crossorigin="anonymous"
    defer
    async></script>

  <script>
    function initScrollSpy() {
      var headings = document.querySelectorAll(
        ".post-content h1[id], .post-content h2[id], .post-content h3[id], .post-content h4[id], .post-content h5[id], .post-content h6[id]",
      );
      var currentHash = "";

      function updateHash(hash) {
        if (hash !== currentHash) {
          currentHash = hash;
          history.replaceState(
            null,
            "",
            hash ? `#${hash}` : window.location.pathname,
          );
        }
      }

      function findActiveHeading() {
        var scrollPosition = window.scrollY + 100;

        for (var i = headings.length - 1; i >= 0; i--) {
          var heading = headings[i];
          // @ts-ignore
          if (heading.offsetTop <= scrollPosition) {
            return heading.id;
          }
        }
        return "";
      }

      function handleScroll() {
        var activeId = findActiveHeading();
        updateHash(activeId);
      }

      var timeoutId;
      window.addEventListener(
        "scroll",
        function onScroll() {
          if (timeoutId) {
            window.cancelAnimationFrame(timeoutId);
          }
          timeoutId = window.requestAnimationFrame(handleScroll);
        },
        { passive: true },
      );

      if (window.location.hash) {
        var targetId = window.location.hash.slice(1);
        var targetElement = document.getElementById(targetId);
        if (targetElement) {
          setTimeout(function scrollToTarget() {
            targetElement.scrollIntoView({
              behavior: "smooth",
              block: "start",
            });
          }, 100);
        }
      }
    }

    if (document.readyState === "loading") {
      document.addEventListener("DOMContentLoaded", initScrollSpy);
    } else {
      initScrollSpy();
    }
  </script>

  <script>
    function initPermalinks() {
      var headings = document.querySelectorAll(
        ".post-content h1[id], .post-content h2[id], .post-content h3[id], .post-content h4[id], .post-content h5[id], .post-content h6[id]",
      );

      headings.forEach(function processHeading(heading) {
        var link = document.createElement("a");
        link.className = "permalink-icon";
        link.href = "#" + heading.id;
        link.setAttribute("aria-label", "Copy link to " + heading.textContent);
        link.innerHTML =
          '<svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M10 13a5 5 0 0 0 7.54.54l3-3a5 5 0 0 0-7.07-7.07l-1.72 1.71"></path><path d="M14 11a5 5 0 0 0-7.54-.54l-3 3a5 5 0 0 0 7.07 7.07l1.71-1.71"></path></svg>';

        link.addEventListener("click", function handleClick(e) {
          e.preventDefault();
          var url =
            window.location.origin +
            window.location.pathname +
            "#" +
            heading.id;

          navigator.clipboard.writeText(url).then(function onSuccess() {
            link.classList.add("copied");
            var originalHTML = link.innerHTML;
            link.innerHTML =
              '<svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="20 6 9 17 4 12"></polyline></svg>';

            setTimeout(function resetIcon() {
              link.innerHTML = originalHTML;
              link.classList.remove("copied");
            }, 2000);
          });
        });

        heading.appendChild(link);
      });
    }

    if (document.readyState === "loading") {
      document.addEventListener("DOMContentLoaded", initPermalinks);
    } else {
      initPermalinks();
    }
  </script>

  <script>
    import mediumZoom from "medium-zoom";

    mediumZoom("img", {
      margin: 24,
      background: "#000000dd",
    });
  </script>

  <article class="blog-post">
    <div class="container-narrow">
      <header class="post-header">
        <a href="/blog" class="back-link">
          <svg
            width="20"
            height="20"
            viewBox="0 0 24 24"
            fill="none"
            stroke="currentColor"
            stroke-width="2"
          >
            <line x1="19" y1="12" x2="5" y2="12"></line>
            <polyline points="12 19 5 12 12 5"></polyline>
          </svg>
          Back to Blog
        </a>

        {seriesInfo && <SeriesBanner seriesInfo={seriesInfo} />}

        <h1 class="post-title gradient-text">{title}</h1>
        <p class="post-description">{description}</p>

        <div class="post-meta">
          <div class="meta-item">
            <span class="meta-label">By</span>
            <span class="meta-value">{author}</span>
          </div>
          <div class="meta-divider">•</div>
          <div class="meta-item">
            <span class="meta-label">Published</span>
            <time datetime={pubDate.toISOString()} class="meta-value"
              >{formattedPubDate}</time
            >
          </div>
          {
            formattedUpdatedDate && (
              <>
                <div class="meta-divider">•</div>
                <div class="meta-item">
                  <span class="meta-label">Updated</span>
                  <time
                    datetime={updatedDate!.toISOString()}
                    class="meta-value"
                  >
                    {formattedUpdatedDate}
                  </time>
                </div>
              </>
            )
          }
          <div class="meta-divider">•</div>
          <div class="meta-item">
            <svg
              class="meta-icon"
              width="16"
              height="16"
              viewBox="0 0 24 24"
              fill="none"
              stroke="currentColor"
              stroke-width="2"
            >
              <circle cx="12" cy="12" r="10"></circle>
              <polyline points="12 6 12 12 16 14"></polyline>
            </svg>
            <span class="meta-value">{readingTime} min read</span>
          </div>
          {
            pageViews !== undefined && pageViews > 0 && (
              <>
                <div class="meta-divider">•</div>
                <div class="meta-item">
                  <svg
                    class="meta-icon"
                    width="16"
                    height="16"
                    viewBox="0 0 24 24"
                    fill="none"
                    stroke="currentColor"
                    stroke-width="2"
                  >
                    <path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z" />
                    <circle cx="12" cy="12" r="3" />
                  </svg>
                  <span class="meta-value">
                    {pageViews.toLocaleString()} views
                  </span>
                </div>
              </>
            )
          }
        </div>

        {
          tags.length > 0 && (
            <div class="post-tags">
              {tags.map(function mapTags(tag) {
                return (
                  <a href={`/blog/tags/${tag}`} class="tag">
                    {tag}
                  </a>
                );
              })}
            </div>
          )
        }

        <SummarizeButton client:only="vue" />
      </header>

      <TableOfContents
        headings={headings}
        hasReferences={references && references.length > 0}
        hasRelatedPosts={relatedPosts && relatedPosts.length > 0}
      />

      <div class="post-content">
        <slot />
      </div>

      {seriesInfo && <SeriesNav seriesInfo={seriesInfo} />}

      {
        references && references.length > 0 && (
          <aside class="references-section" id="references">
            <h2 class="references-title">
              <svg
                class="references-icon"
                width="24"
                height="24"
                viewBox="0 0 24 24"
                fill="none"
                stroke="currentColor"
                stroke-width="2"
              >
                <path d="M13 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V9z" />
                <polyline points="13 2 13 9 20 9" />
              </svg>
              References & Further Reading
            </h2>
            <p class="references-intro">
              Want to dive deeper? Here are the sources and additional resources
              that informed this article.
            </p>
            <ul class="references-list">
              {references.map(function mapReferences(ref) {
                return (
                  <li class="reference-item">
                    <a
                      href={ref.url}
                      class="reference-link"
                      target="_blank"
                      rel="noopener noreferrer"
                    >
                      <span class="reference-title">{ref.title}</span>
                      <svg
                        class="external-icon"
                        width="16"
                        height="16"
                        viewBox="0 0 24 24"
                        fill="none"
                        stroke="currentColor"
                        stroke-width="2"
                      >
                        <path d="M18 13v6a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h6" />
                        <polyline points="15 3 21 3 21 9" />
                        <line x1="10" y1="14" x2="21" y2="3" />
                      </svg>
                    </a>
                    {ref.description && (
                      <p class="reference-description">{ref.description}</p>
                    )}
                  </li>
                );
              })}
            </ul>
          </aside>
        )
      }

      {
        relatedPosts && relatedPosts.length > 0 && (
          <aside class="related-section" id="related-reading">
            <h2 class="related-title">
              <svg
                class="related-icon"
                width="24"
                height="24"
                viewBox="0 0 24 24"
                fill="none"
                stroke="currentColor"
                stroke-width="2"
              >
                <path d="M10 13a5 5 0 0 0 7.54.54l3-3a5 5 0 0 0-7.07-7.07l-1.72 1.71" />
                <path d="M14 11a5 5 0 0 0-7.54-.54l-3 3a5 5 0 0 0 7.07 7.07l1.71-1.71" />
              </svg>
              Related Reading
            </h2>
            <p class="related-intro">
              Explore more articles on similar topics from this blog.
            </p>
            <ul class="related-list">
              {relatedPosts.map(function mapRelatedPosts(post) {
                return (
                  <li class="related-item">
                    <a href={`/blog/${post.slug}`} class="related-link">
                      <span class="related-post-title">{post.data.title}</span>
                      <svg
                        class="arrow-icon"
                        width="16"
                        height="16"
                        viewBox="0 0 24 24"
                        fill="none"
                        stroke="currentColor"
                        stroke-width="2"
                      >
                        <line x1="5" y1="12" x2="19" y2="12" />
                        <polyline points="12 5 19 12 12 19" />
                      </svg>
                    </a>
                    <p class="related-description">{post.data.description}</p>
                  </li>
                );
              })}
            </ul>
          </aside>
        )
      }

      <div class="newsletter-cta">
        <Newsletter variant="section" />
      </div>
    </div>
  </article>

  <div class="blog-post-extras">
    <div class="container-narrow">
      <div class="giscus comments-section"></div>
      <Webmentions url={fullURL} />
    </div>
  </div>
</BaseLayout>

<style scoped>
  .blog-post {
    padding: var(--space-2xl) 0;
  }

  .post-header {
    margin-bottom: var(--space-2xl);
    padding-bottom: var(--space-xl);
    border-bottom: 1px solid var(--color-border);
  }

  .back-link {
    display: inline-flex;
    align-items: center;
    gap: var(--space-xs);
    color: var(--color-text-muted);
    font-size: var(--text-md);
    font-weight: 500;
    margin-bottom: var(--space-lg);
    transition: all var(--transition-fast);
  }

  .back-link:hover {
    color: var(--color-text);
    gap: var(--space-sm);
  }

  .back-link svg {
    transition: transform var(--transition-fast);
  }

  .back-link:hover svg {
    transform: translateX(-4px);
  }

  .post-title {
    margin-bottom: var(--space-md);
  }

  .post-description {
    font-size: var(--text-xl);
    color: var(--color-text-muted);
    margin-bottom: var(--space-lg);
    line-height: 1.7;
  }

  .post-meta {
    display: flex;
    align-items: center;
    gap: var(--space-sm);
    flex-wrap: wrap;
    margin-bottom: var(--space-md);
  }

  .meta-item {
    display: flex;
    align-items: center;
    gap: var(--space-xxs);
    font-size: var(--text-md);
  }

  .meta-icon {
    color: var(--color-text-dim);
    flex-shrink: 0;
  }

  .meta-label {
    color: var(--color-text-dim);
  }

  .meta-value {
    color: var(--color-text-muted);
    font-weight: 500;
  }

  .meta-divider {
    color: var(--color-text-dim);
  }

  .post-tags {
    display: flex;
    gap: var(--space-sm);
    flex-wrap: wrap;
  }

  .tag {
    padding: var(--space-xxs) var(--space-sm);
    font-size: var(--text-sm);
    font-weight: 500;
    background: var(--color-bg-card);
    border: 1px solid var(--color-border);
    border-radius: var(--radius-sm);
    color: var(--color-text-muted);
    transition: all var(--transition-fast);
  }

  .tag:hover {
    border-color: var(--color-accent);
    color: var(--color-accent-light);
    background: var(--color-accent-bg);
  }

  .post-content {
    margin-bottom: var(--space-2xl);
  }

  .post-content :global(h2) {
    margin-top: var(--space-2xl);
    margin-bottom: var(--space-md);
    padding-top: var(--space-sm);
    border-top: 1px solid var(--color-border);
  }

  .post-content :global(h3) {
    margin-top: var(--space-xl);
    margin-bottom: var(--space-sm);
  }

  .post-content :global(h4),
  .post-content :global(h5),
  .post-content :global(h6) {
    margin-top: var(--space-lg);
    margin-bottom: var(--space-sm);
  }

  .post-content :global(p) {
    margin-bottom: var(--space-md);
    font-size: 1.0625rem;
    line-height: 1.8;
  }

  .post-content :global(ul),
  .post-content :global(ol) {
    margin-bottom: var(--space-md);
    padding-left: var(--space-lg);
    color: var(--color-text-muted);
  }

  .post-content :global(li) {
    margin-bottom: var(--space-sm);
    line-height: 1.8;
  }

  .post-content :global(code) {
    font-family: var(--font-mono);
    font-size: 0.9em;
    background: var(--color-bg-card);
    border: 1px solid var(--color-border);
    border-radius: var(--radius-xs);
    padding: var(--space-xxxs) var(--space-xxs);
    color: var(--color-accent-light);
  }

  .post-content :global(pre) {
    margin-bottom: var(--space-md);
    padding: var(--space-md);
    background: var(--color-bg-card);
    border: 1px solid var(--color-border);
    border-radius: var(--radius-sm);
    overflow-x: auto;
  }

  .post-content :global(pre code) {
    background: none;
    border: none;
    padding: 0;
    font-size: var(--text-sm);
    color: var(--color-text);
  }

  .post-content :global(blockquote) {
    margin: var(--space-lg) 0;
    padding-left: var(--space-lg);
    border-left: 3px solid var(--color-accent);
    color: var(--color-text-muted);
    font-style: italic;
  }

  .post-content :global(img) {
    max-width: 100%;
    height: auto;
    border-radius: var(--radius-sm);
    margin: var(--space-lg) 0;
  }

  .post-content :global(a) {
    color: var(--color-accent-light);
    border-bottom: 1px solid transparent;
    transition: border-color var(--transition-fast);
  }

  .post-content :global(a:hover) {
    border-bottom-color: var(--color-accent);
  }

  .post-content :global(table) {
    width: 100%;
    margin: var(--space-lg) 0;
    border-collapse: collapse;
    font-size: var(--text-md);
    background: var(--color-bg-card);
    border: 1px solid var(--color-border);
    border-radius: var(--radius-sm);
    overflow: hidden;
  }

  .post-content :global(thead) {
    background: var(--color-bg-elevated);
  }

  .post-content :global(th) {
    padding: var(--space-sm) var(--space-md);
    text-align: left;
    font-weight: 600;
    color: var(--color-text);
    border-bottom: 2px solid var(--color-border);
  }

  .post-content :global(td) {
    padding: var(--space-sm) var(--space-md);
    color: var(--color-text-muted);
    border-bottom: 1px solid var(--color-border);
  }

  .post-content :global(tr:last-child td) {
    border-bottom: none;
  }

  .post-content :global(tbody tr:hover) {
    background: var(--color-accent-bg-subtle);
  }

  .post-content :global(.heading-link) {
    text-decoration: none;
    color: inherit;
    display: block;
    scroll-margin-top: calc(var(--size-header) + var(--space-md));
  }

  .post-content :global(.heading-link:hover) {
    border: none;
  }

  .post-content :global(h1[id]),
  .post-content :global(h2[id]),
  .post-content :global(h3[id]),
  .post-content :global(h4[id]),
  .post-content :global(h5[id]),
  .post-content :global(h6[id]) {
    scroll-margin-top: calc(var(--size-header) + var(--space-md));
    position: relative;
  }

  .post-content :global(.permalink-icon) {
    display: inline-flex;
    align-items: center;
    margin-left: var(--space-xs);
    color: var(--color-text-dim);
    opacity: 0;
    transition:
      opacity var(--transition-fast),
      color var(--transition-fast);
    text-decoration: none;
    border: none;
    vertical-align: middle;
  }

  .post-content :global(h1:hover .permalink-icon),
  .post-content :global(h2:hover .permalink-icon),
  .post-content :global(h3:hover .permalink-icon),
  .post-content :global(h4:hover .permalink-icon),
  .post-content :global(h5:hover .permalink-icon),
  .post-content :global(h6:hover .permalink-icon) {
    opacity: 1;
  }

  .post-content :global(.permalink-icon:hover) {
    color: var(--color-accent);
    border: none;
  }

  .post-content :global(.permalink-icon.copied) {
    color: var(--color-success);
  }

  @media (max-width: 768px) {
    .post-meta {
      flex-direction: column;
      align-items: flex-start;
      gap: var(--space-xs);
    }

    .meta-divider {
      display: none;
    }

    .post-content :global(.permalink-icon) {
      opacity: 0.5;
    }
  }

  .references-section {
    margin-top: var(--space-2xl);
    padding: var(--space-xl);
    background: var(--color-bg-card);
    border: 1px solid var(--color-border);
    border-radius: var(--radius);
  }

  .references-title {
    display: flex;
    align-items: center;
    gap: var(--space-sm);
    font-size: var(--text-2xl);
    margin-bottom: var(--space-md);
    color: var(--color-text);
    border: none;
    padding: 0;
    margin-top: 0;
  }

  .references-icon {
    color: var(--color-accent);
    flex-shrink: 0;
  }

  .references-intro {
    color: var(--color-text-muted);
    margin-bottom: var(--space-lg);
    font-size: var(--text-base);
    line-height: 1.6;
  }

  .references-list {
    list-style: none;
    padding: 0;
    margin: 0;
    display: flex;
    flex-direction: column;
    gap: var(--space-md);
  }

  .reference-item {
    padding: var(--space-md);
    background: var(--color-bg);
    border: 1px solid var(--color-border);
    border-radius: var(--radius-sm);
    transition: all var(--transition-fast);
    margin: 0;
  }

  .reference-item:hover {
    border-color: var(--color-accent);
    background: var(--color-accent-bg-subtle);
  }

  .reference-link {
    display: flex;
    align-items: center;
    gap: var(--space-xs);
    text-decoration: none;
    color: var(--color-text);
    font-weight: 500;
    border: none;
    transition: color var(--transition-fast);
  }

  .reference-link:hover {
    color: var(--color-accent-light);
    border: none;
  }

  .reference-title {
    flex: 1;
  }

  .external-icon {
    color: var(--color-text-dim);
    flex-shrink: 0;
    transition: transform var(--transition-fast);
  }

  .reference-link:hover .external-icon {
    transform: translate(2px, -2px);
    color: var(--color-accent);
  }

  .reference-description {
    margin-top: var(--space-xs);
    margin-bottom: 0;
    font-size: var(--text-md);
    color: var(--color-text-muted);
    line-height: 1.6;
  }

  .related-section {
    margin-top: var(--space-2xl);
    padding: var(--space-xl);
    background: var(--color-bg-card);
    border: 1px solid var(--color-border);
    border-radius: var(--radius);
  }

  .related-title {
    display: flex;
    align-items: center;
    gap: var(--space-sm);
    font-size: var(--text-2xl);
    margin-bottom: var(--space-md);
    color: var(--color-text);
    border: none;
    padding: 0;
    margin-top: 0;
  }

  .related-icon {
    color: var(--color-accent);
    flex-shrink: 0;
  }

  .related-intro {
    color: var(--color-text-muted);
    margin-bottom: var(--space-lg);
    font-size: var(--text-base);
    line-height: 1.6;
  }

  .related-list {
    list-style: none;
    padding: 0;
    margin: 0;
    display: flex;
    flex-direction: column;
    gap: var(--space-md);
  }

  .related-item {
    padding: var(--space-md);
    background: var(--color-bg);
    border: 1px solid var(--color-border);
    border-radius: var(--radius-sm);
    transition: all var(--transition-fast);
    margin: 0;
  }

  .related-item:hover {
    border-color: var(--color-accent);
    background: var(--color-accent-bg-subtle);
  }

  .related-link {
    display: flex;
    align-items: center;
    gap: var(--space-xs);
    text-decoration: none;
    color: var(--color-text);
    font-weight: 500;
    border: none;
    transition: color var(--transition-fast);
  }

  .related-link:hover {
    color: var(--color-accent-light);
    border: none;
  }

  .related-post-title {
    flex: 1;
  }

  .arrow-icon {
    color: var(--color-text-dim);
    flex-shrink: 0;
    transition: transform var(--transition-fast);
  }

  .related-link:hover .arrow-icon {
    transform: translateX(4px);
    color: var(--color-accent);
  }

  .related-description {
    margin-top: var(--space-xs);
    margin-bottom: 0;
    font-size: var(--text-md);
    color: var(--color-text-muted);
    line-height: 1.6;
  }

  .newsletter-cta {
    max-width: var(--container-narrow);
    margin: 0 auto;
    padding-top: var(--space-2xl);
    border-top: 1px solid var(--color-border);
  }

  .blog-post-extras {
    padding: var(--space-3xl) 0;
    background: var(--color-bg-elevated);
  }

  .comments-section {
    margin-bottom: var(--space-3xl);
  }
</style>
