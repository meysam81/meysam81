---
import { getCollection } from "astro:content";
import BaseLayout from "@/layouts/BaseLayout.astro";
import ContentCard from "@/components/ContentCard.astro";
import TagsFilter from "@/components/TagsFilter.astro";
import BackLink from "@/components/BackLink.astro";
import {
  filterPublishedPosts,
  formatDate,
  getAllTags,
  getPostsByTag,
} from "@/utils/blog";

export async function getStaticPaths() {
  var allPosts = await getCollection("blog");
  var publishedPosts = filterPublishedPosts(allPosts);
  var allTags = getAllTags(publishedPosts);

  return allTags.map(function createPath(tag) {
    var tagPosts = getPostsByTag(publishedPosts, tag);
    return {
      params: { tag },
      props: { tag, posts: tagPosts },
    };
  });
}

var { tag, posts } = Astro.props;

// Get all tags for the filter (need all published posts)
var allPosts = await getCollection("blog");
var publishedPosts = filterPublishedPosts(allPosts);
var allTags = getAllTags(publishedPosts);
---

<BaseLayout
  title={`Posts tagged "${tag}" - Meysam Azad`}
  description={`All blog posts tagged with ${tag}`}
>
  <section class="tag-page">
    <div class="container">
      <div class="header">
        <BackLink href="/blog" text="Back to Blog" />

        <h1>Posts tagged "{tag}"</h1>
        <p class="subtitle">
          {posts.length} post{posts.length !== 1 ? "s" : ""} found
        </p>
      </div>

      <TagsFilter tags={allTags} activeTag={tag} class="mb-xl" />

      <div class="grid grid-3">
        {
          posts.map(function mapPosts(post) {
            var postSlug = post.slug || post.id;
            return (
              <ContentCard
                title={post.data.title}
                description={post.data.description}
                url={"/blog/" + postSlug}
                badge={formatDate(post.data.pubDate)}
                linkText="Read Article"
              />
            );
          })
        }
      </div>
    </div>
  </section>
</BaseLayout>

<style scoped>
  .tag-page {
    padding: var(--space-2xl) 0;
  }

  .header {
    margin-bottom: var(--space-2xl);
  }

  .header h1 {
    margin-bottom: var(--space-sm);
    background: linear-gradient(
      135deg,
      var(--color-text) 0%,
      var(--color-accent-light) 100%
    );
    -webkit-background-clip: text;
    -webkit-text-fill-color: transparent;
    background-clip: text;
  }

  .subtitle {
    color: var(--color-text-muted);
    font-size: var(--text-lg);
    margin: 0;
  }
</style>
