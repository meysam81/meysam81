---
import ToolLayout from '@/layouts/ToolLayout.astro';

// Structured Data - WebApplication Schema (Schema.org)
const structuredData = {
  "@context": "https://schema.org",
  "@type": "WebApplication",
  "name": "YAML/JSON Validator & Converter",
  "description": "Validate, format, and convert between YAML and JSON instantly. Free online tool with detailed error messages, line numbers, and RFC compliance. No signup required.",
  "url": "https://meysam.io/tools/yaml-json",
  "applicationCategory": "DeveloperApplication",
  "operatingSystem": "Any",
  "browserRequirements": "Requires JavaScript",
  "offers": {
    "@type": "Offer",
    "price": "0",
    "priceCurrency": "USD"
  },
  "featureList": [
    "YAML 1.2 specification compliance",
    "JSON RFC 8259 compliance",
    "Bidirectional YAML/JSON conversion",
    "Detailed error messages with line numbers",
    "Auto-format detection",
    "Pretty-print formatting",
    "Copy to clipboard",
    "Download as file",
    "Client-side processing (data never leaves your browser)"
  ],
  "author": {
    "@type": "Person",
    "name": "Meysam Azad",
    "url": "https://meysam.io"
  }
};

// FAQ Structured Data
const faqData = {
  "@context": "https://schema.org",
  "@type": "FAQPage",
  "mainEntity": [
    {
      "@type": "Question",
      "name": "How do I validate YAML online?",
      "acceptedAnswer": {
        "@type": "Answer",
        "text": "Paste your YAML content into the input editor. The validator automatically detects YAML format and validates it against the YAML 1.2 specification. Any syntax errors will be displayed with line numbers and helpful suggestions for fixing them."
      }
    },
    {
      "@type": "Question",
      "name": "How do I convert YAML to JSON?",
      "acceptedAnswer": {
        "@type": "Answer",
        "text": "Paste your YAML content and click the 'Convert to JSON' button. The tool parses your YAML according to the YAML 1.2 spec and outputs valid JSON following RFC 8259. You can then copy or download the result."
      }
    },
    {
      "@type": "Question",
      "name": "How do I convert JSON to YAML?",
      "acceptedAnswer": {
        "@type": "Answer",
        "text": "Paste your JSON content and click the 'Convert to YAML' button. The tool validates your JSON against RFC 8259 and converts it to clean, properly indented YAML 1.2 format."
      }
    },
    {
      "@type": "Question",
      "name": "What causes YAML syntax errors?",
      "acceptedAnswer": {
        "@type": "Answer",
        "text": "Common YAML errors include: incorrect indentation (YAML uses spaces, not tabs), missing colons after keys, unquoted special characters, improper list formatting, and duplicate keys. Our validator shows the exact line and column where errors occur."
      }
    },
    {
      "@type": "Question",
      "name": "Is my data secure when using this validator?",
      "acceptedAnswer": {
        "@type": "Answer",
        "text": "Yes, absolutely. All validation and conversion happens entirely in your browser using JavaScript. Your data never leaves your device and is never sent to any server. This is a 100% client-side tool."
      }
    },
    {
      "@type": "Question",
      "name": "What YAML version does this validator support?",
      "acceptedAnswer": {
        "@type": "Answer",
        "text": "This validator supports YAML 1.2, the latest stable version of the YAML specification. It handles all standard YAML features including anchors, aliases, multi-line strings, and complex nested structures."
      }
    },
    {
      "@type": "Question",
      "name": "Can I validate Kubernetes YAML files?",
      "acceptedAnswer": {
        "@type": "Answer",
        "text": "Yes! This tool validates the YAML syntax of Kubernetes manifests, Helm charts, Docker Compose files, GitHub Actions workflows, and any other YAML-based configuration files. It checks for valid YAML structure but not Kubernetes-specific schema validation."
      }
    },
    {
      "@type": "Question",
      "name": "What is the difference between YAML and JSON?",
      "acceptedAnswer": {
        "@type": "Answer",
        "text": "YAML and JSON are both data serialization formats. YAML is a superset of JSON, meaning valid JSON is also valid YAML. YAML uses indentation for structure and is more human-readable, while JSON uses braces and brackets and is more compact. YAML supports comments; JSON does not."
      }
    }
  ]
};

// Common YAML errors with suggestions
const commonErrors = [
  { pattern: "tabs", title: "Tab Characters", description: "YAML requires spaces for indentation, not tabs", suggestion: "Replace all tabs with spaces (typically 2 spaces per level)" },
  { pattern: "colon", title: "Missing Colon", description: "Keys must be followed by a colon and space", suggestion: "Add a colon after the key name: key: value" },
  { pattern: "indent", title: "Inconsistent Indentation", description: "All items at the same level must have identical indentation", suggestion: "Use consistent 2-space indentation throughout" },
  { pattern: "quote", title: "Unquoted Special Characters", description: "Values with special characters need quotes", suggestion: "Wrap values containing : @ # & * in quotes" },
  { pattern: "duplicate", title: "Duplicate Keys", description: "Each key must be unique within its mapping", suggestion: "Rename or remove the duplicate key" },
  { pattern: "anchor", title: "Invalid Anchor/Alias", description: "Anchors (&) and aliases (*) must reference valid nodes", suggestion: "Ensure anchor is defined before alias reference" }
];

// YAML syntax reference
const yamlSyntax = [
  { syntax: "key: value", description: "Key-value pair (mapping)", example: "name: John" },
  { syntax: "- item", description: "List item (sequence)", example: "- apple\\n- banana" },
  { syntax: "|", description: "Literal block scalar (preserves newlines)", example: "text: |\\n  line1\\n  line2" },
  { syntax: ">", description: "Folded block scalar (joins lines)", example: "text: >\\n  long\\n  text" },
  { syntax: "&anchor", description: "Define an anchor", example: "defaults: &defaults\\n  timeout: 30" },
  { syntax: "*alias", description: "Reference an anchor", example: "production:\\n  <<: *defaults" },
  { syntax: "# comment", description: "Comment (ignored)", example: "# This is a comment" },
  { syntax: "---", description: "Document start marker", example: "---\\ndoc1\\n---\\ndoc2" },
  { syntax: "...", description: "Document end marker", example: "data: value\\n..." },
  { syntax: "null / ~", description: "Null value", example: "empty: null" },
  { syntax: "true / false", description: "Boolean values", example: "enabled: true" },
  { syntax: "'string'", description: "Single-quoted string (literal)", example: "path: 'C:\\\\path'" },
  { syntax: "\"string\"", description: "Double-quoted string (escapes)", example: "msg: \"Hello\\\\nWorld\"" }
];
---

<ToolLayout
  title="YAML/JSON Validator & Converter"
  description="Validate, format, and convert between YAML and JSON instantly. Free online tool with detailed error messages and line numbers. No signup required."
  ogImage="https://meysam.io/og/yaml-json.png"
  canonicalPath="/tools/yaml-json"
  structuredData={structuredData}
>
  <Fragment slot="head">
    <script type="application/ld+json" set:html={JSON.stringify(faqData)} />
  </Fragment>

  <!-- Tool Header -->
  <div class="tool-header">
    <h1>YAML/JSON Validator & Converter</h1>
    <p class="subtitle">Validate, format, and convert between YAML and JSON. Client-side processing — your data never leaves your browser.</p>
  </div>

  <div class="tool-content">
    <!-- Main Tool Card -->
    <div class="tool-card validator-tool">
      <!-- Format Detection Banner -->
      <div class="format-banner" id="format-banner">
        <span class="format-indicator" id="format-indicator">
          <span class="format-icon">?</span>
          <span class="format-text">Paste content to detect format</span>
        </span>
        <div class="format-actions">
          <button type="button" class="action-chip" id="format-yaml-btn" aria-label="Format as YAML" disabled>
            Format as YAML
          </button>
          <button type="button" class="action-chip" id="format-json-btn" aria-label="Format as JSON" disabled>
            Format as JSON
          </button>
        </div>
      </div>

      <!-- Editor Section -->
      <div class="editor-section">
        <!-- Input Editor -->
        <div class="editor-pane">
          <div class="editor-header">
            <label for="input-editor" class="editor-label">Input</label>
            <div class="editor-actions">
              <button type="button" class="icon-btn" id="paste-btn" title="Paste from clipboard">
                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                  <path d="M16 4h2a2 2 0 0 1 2 2v14a2 2 0 0 1-2 2H6a2 2 0 0 1-2-2V6a2 2 0 0 1 2-2h2"></path>
                  <rect x="8" y="2" width="8" height="4" rx="1" ry="1"></rect>
                </svg>
              </button>
              <button type="button" class="icon-btn" id="clear-btn" title="Clear input">
                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                  <line x1="18" y1="6" x2="6" y2="18"></line>
                  <line x1="6" y1="6" x2="18" y2="18"></line>
                </svg>
              </button>
              <button type="button" class="icon-btn" id="sample-yaml-btn" title="Load sample YAML">
                YAML
              </button>
              <button type="button" class="icon-btn" id="sample-json-btn" title="Load sample JSON">
                JSON
              </button>
            </div>
          </div>
          <div class="editor-wrapper">
            <div class="line-numbers" id="input-line-numbers"></div>
            <textarea
              id="input-editor"
              class="editor-textarea"
              placeholder="Paste your YAML or JSON here...

Examples:
• Kubernetes manifests
• Docker Compose files
• GitHub Actions workflows
• Any YAML/JSON configuration"
              spellcheck="false"
              autocomplete="off"
              autocorrect="off"
              autocapitalize="off"
            ></textarea>
          </div>
          <!-- Error/Success Messages -->
          <div class="message-area">
            <div class="error-message hidden" id="error-message">
              <svg class="message-icon" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <circle cx="12" cy="12" r="10"></circle>
                <line x1="12" y1="8" x2="12" y2="12"></line>
                <line x1="12" y1="16" x2="12.01" y2="16"></line>
              </svg>
              <div class="message-content">
                <span class="message-text" id="error-text"></span>
                <span class="message-location" id="error-location"></span>
                <span class="message-suggestion" id="error-suggestion"></span>
              </div>
            </div>
            <div class="success-message hidden" id="success-message">
              <svg class="message-icon" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"></path>
                <polyline points="22 4 12 14.01 9 11.01"></polyline>
              </svg>
              <span class="message-text" id="success-text">Valid!</span>
            </div>
          </div>
        </div>

        <!-- Action Buttons (Center) -->
        <div class="action-buttons">
          <button type="button" class="btn btn-primary" id="convert-btn" disabled>
            <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <polyline points="17 1 21 5 17 9"></polyline>
              <path d="M3 11V9a4 4 0 0 1 4-4h14"></path>
              <polyline points="7 23 3 19 7 15"></polyline>
              <path d="M21 13v2a4 4 0 0 1-4 4H3"></path>
            </svg>
            <span id="convert-btn-text">Convert</span>
          </button>
        </div>

        <!-- Output Editor -->
        <div class="editor-pane">
          <div class="editor-header">
            <label for="output-editor" class="editor-label">
              Output
              <span class="output-format-badge hidden" id="output-format-badge">JSON</span>
            </label>
            <div class="editor-actions">
              <button type="button" class="icon-btn" id="copy-btn" title="Copy to clipboard" disabled>
                <svg class="copy-icon" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                  <rect x="9" y="9" width="13" height="13" rx="2" ry="2"></rect>
                  <path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"></path>
                </svg>
                <svg class="check-icon hidden" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                  <polyline points="20 6 9 17 4 12"></polyline>
                </svg>
              </button>
              <button type="button" class="icon-btn" id="download-btn" title="Download file" disabled>
                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                  <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path>
                  <polyline points="7 10 12 15 17 10"></polyline>
                  <line x1="12" y1="15" x2="12" y2="3"></line>
                </svg>
              </button>
            </div>
          </div>
          <div class="editor-wrapper">
            <div class="line-numbers" id="output-line-numbers"></div>
            <textarea
              id="output-editor"
              class="editor-textarea"
              placeholder="Converted output will appear here..."
              readonly
              spellcheck="false"
            ></textarea>
          </div>
        </div>
      </div>

      <!-- Options Section -->
      <div class="options-section">
        <div class="option-group">
          <label class="option-label">
            <input type="checkbox" id="option-minify" />
            <span>Minify output</span>
          </label>
          <label class="option-label">
            <input type="number" id="option-indent" value="2" min="1" max="8" />
            <span>Indent spaces</span>
          </label>
          <label class="option-label">
            <input type="checkbox" id="option-sort-keys" />
            <span>Sort keys alphabetically</span>
          </label>
        </div>
      </div>
    </div>

    <!-- Statistics Card -->
    <div class="tool-card stats-card hidden" id="stats-card">
      <h2>Document Statistics</h2>
      <div class="stats-grid">
        <div class="stat-item">
          <span class="stat-value" id="stat-lines">0</span>
          <span class="stat-label">Lines</span>
        </div>
        <div class="stat-item">
          <span class="stat-value" id="stat-chars">0</span>
          <span class="stat-label">Characters</span>
        </div>
        <div class="stat-item">
          <span class="stat-value" id="stat-keys">0</span>
          <span class="stat-label">Keys</span>
        </div>
        <div class="stat-item">
          <span class="stat-value" id="stat-depth">0</span>
          <span class="stat-label">Max Depth</span>
        </div>
      </div>
    </div>

    <!-- Reference Section: YAML Syntax -->
    <div class="tool-card reference-section">
      <h2>YAML Syntax Reference</h2>
      <p class="section-intro">Quick reference for YAML 1.2 syntax. YAML is a superset of JSON, so valid JSON is also valid YAML.</p>
      <div class="reference-table-wrapper">
        <table class="reference-table">
          <thead>
            <tr>
              <th>Syntax</th>
              <th>Description</th>
              <th>Example</th>
            </tr>
          </thead>
          <tbody>
            {yamlSyntax.map(item => (
              <tr>
                <td><code>{item.syntax}</code></td>
                <td>{item.description}</td>
                <td><code class="example-code">{item.example}</code></td>
              </tr>
            ))}
          </tbody>
        </table>
      </div>
    </div>

    <!-- Reference Section: Common Errors -->
    <div class="tool-card errors-section">
      <h2>Common YAML Errors & How to Fix Them</h2>
      <div class="errors-grid">
        {commonErrors.map(error => (
          <div class="error-card">
            <h3>{error.title}</h3>
            <p class="error-description">{error.description}</p>
            <p class="error-fix"><strong>Fix:</strong> {error.suggestion}</p>
          </div>
        ))}
      </div>
    </div>

    <!-- FAQ Section -->
    <div class="tool-card faq-section">
      <h2>Frequently Asked Questions</h2>

      <details class="faq-item">
        <summary>How do I validate YAML online?</summary>
        <p>Paste your YAML content into the input editor. The validator automatically detects YAML format and validates it against the YAML 1.2 specification. Any syntax errors will be displayed with line numbers and helpful suggestions for fixing them.</p>
      </details>

      <details class="faq-item">
        <summary>How do I convert YAML to JSON?</summary>
        <p>Paste your YAML content and click the "Convert to JSON" button. The tool parses your YAML according to the YAML 1.2 spec and outputs valid JSON following RFC 8259. You can then copy or download the result.</p>
      </details>

      <details class="faq-item">
        <summary>How do I convert JSON to YAML?</summary>
        <p>Paste your JSON content and click the "Convert to YAML" button. The tool validates your JSON against RFC 8259 and converts it to clean, properly indented YAML 1.2 format.</p>
      </details>

      <details class="faq-item">
        <summary>What causes YAML syntax errors?</summary>
        <p>Common YAML errors include: incorrect indentation (YAML uses spaces, not tabs), missing colons after keys, unquoted special characters, improper list formatting, and duplicate keys. Our validator shows the exact line and column where errors occur.</p>
      </details>

      <details class="faq-item">
        <summary>Is my data secure when using this validator?</summary>
        <p>Yes, absolutely. All validation and conversion happens entirely in your browser using JavaScript. Your data never leaves your device and is never sent to any server. This is a 100% client-side tool. You can verify this by checking your browser's network tab — no data is transmitted.</p>
      </details>

      <details class="faq-item">
        <summary>What YAML version does this validator support?</summary>
        <p>This validator supports YAML 1.2, the latest stable version of the YAML specification. It handles all standard YAML features including anchors, aliases, multi-line strings, block scalars, and complex nested structures.</p>
      </details>

      <details class="faq-item">
        <summary>Can I validate Kubernetes YAML files?</summary>
        <p>Yes! This tool validates the YAML syntax of Kubernetes manifests, Helm charts, Docker Compose files, GitHub Actions workflows, Ansible playbooks, and any other YAML-based configuration files. It checks for valid YAML structure (syntax validation) but not Kubernetes-specific schema validation.</p>
      </details>

      <details class="faq-item">
        <summary>What is the difference between YAML and JSON?</summary>
        <p>YAML and JSON are both data serialization formats. Key differences:</p>
        <ul>
          <li><strong>Readability:</strong> YAML uses indentation and is more human-readable; JSON uses braces/brackets</li>
          <li><strong>Comments:</strong> YAML supports comments (#); JSON does not</li>
          <li><strong>Data types:</strong> YAML supports more types (dates, timestamps, etc.)</li>
          <li><strong>Compatibility:</strong> Valid JSON is valid YAML (YAML is a superset)</li>
          <li><strong>Use cases:</strong> YAML for config files; JSON for APIs and data exchange</li>
        </ul>
      </details>

      <details class="faq-item">
        <summary>What JSON standard does this tool follow?</summary>
        <p>This tool follows RFC 8259 (The JavaScript Object Notation Data Interchange Format), which is the current standard for JSON. It properly handles Unicode characters, escape sequences, number formats, and structural validation.</p>
      </details>
    </div>

    <!-- Newsletter CTA -->
    <div class="tool-card newsletter-section">
      <h2>Like This Tool?</h2>
      <p>Get weekly DevOps tips and production insights from 8+ years of YAML debugging in the trenches.</p>

      <form
        class="newsletter-form listmonk-form"
        data-pirsch-event="subscribe"
        data-pirsch-meta-page_url="/tools/yaml-json"
        data-pirsch-meta-variant="yaml-json-tool"
        data-pirsch-non-interactive
        action="https://newsletter.meysam.io/subscription/form"
        method="post"
      >
        <input type="hidden" name="nonce" />
        <input id="00a2c" type="hidden" name="l" value="00a2c2b8-467a-4d74-9c76-9c6472c91d06" />
        <input type="text" name="name" value="" class="honeypot-field" tabindex="-1" autocomplete="off" aria-hidden="true" />
        <input type="text" name="company" value="" class="honeypot-field" tabindex="-1" autocomplete="off" aria-hidden="true" />
        <input type="text" name="website" value="" class="honeypot-field" tabindex="-1" autocomplete="off" aria-hidden="true" />
        <div class="form-row">
          <input
            type="email"
            name="email"
            placeholder="your@email.com"
            required
            aria-label="Email address"
            class="email-input"
          />
          <altcha-widget
            class="altcha-widget"
            challengeurl="https://newsletter.meysam.io/api/public/captcha/altcha"
            auto="onfocus"
          ></altcha-widget>
          <script type="module" src="https://newsletter.meysam.io/public/static/altcha.umd.js" async defer></script>
          <button type="submit" class="btn btn-primary">Get Weekly Tips</button>
        </div>
        <p class="form-note">Join 1,500+ engineers. No spam, unsubscribe anytime.</p>
      </form>

      <div class="success-message-newsletter hidden" id="newsletter-success">
        <svg width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"></path>
          <polyline points="22 4 12 14.01 9 11.01"></polyline>
        </svg>
        <h3>Check Your Email!</h3>
        <p>Click the confirmation link to complete your subscription.</p>
      </div>
    </div>
  </div>
</ToolLayout>

<script>
  // Import js-yaml from CDN (YAML 1.2 compliant)
  // @ts-ignore - CDN import
  import * as jsyaml from 'https://esm.sh/js-yaml@4.1.0';
  import log from 'loglevel';

  // ============================================================================
  // TYPE DEFINITIONS
  // ============================================================================

  interface ParseResult {
    valid: boolean;
    data?: unknown;
    error?: ParseError;
    format?: 'yaml' | 'json';
  }

  interface ParseError {
    message: string;
    line?: number;
    column?: number;
    reason?: string;
    suggestion?: string;
  }

  interface DocumentStats {
    lines: number;
    characters: number;
    keys: number;
    maxDepth: number;
  }

  // ============================================================================
  // CONSTANTS
  // ============================================================================

  // Sample YAML (Kubernetes Deployment example)
  const SAMPLE_YAML = `# Kubernetes Deployment Example
apiVersion: apps/v1
kind: Deployment
metadata:
  name: my-app
  labels:
    app: my-app
    version: v1.0.0
spec:
  replicas: 3
  selector:
    matchLabels:
      app: my-app
  template:
    metadata:
      labels:
        app: my-app
    spec:
      containers:
        - name: my-app
          image: my-app:1.0.0
          ports:
            - containerPort: 8080
          env:
            - name: NODE_ENV
              value: production
            - name: LOG_LEVEL
              value: info
          resources:
            requests:
              memory: "128Mi"
              cpu: "100m"
            limits:
              memory: "256Mi"
              cpu: "500m"
          livenessProbe:
            httpGet:
              path: /health
              port: 8080
            initialDelaySeconds: 30
            periodSeconds: 10
          readinessProbe:
            httpGet:
              path: /ready
              port: 8080
            initialDelaySeconds: 5
            periodSeconds: 5`;

  // Sample JSON (API response example)
  const SAMPLE_JSON = `{
  "apiVersion": "v1",
  "kind": "ConfigMap",
  "metadata": {
    "name": "app-config",
    "namespace": "default",
    "labels": {
      "app": "my-application",
      "environment": "production"
    }
  },
  "data": {
    "database.host": "db.example.com",
    "database.port": "5432",
    "cache.enabled": "true",
    "cache.ttl": "3600",
    "features": "{\\"darkMode\\": true, \\"beta\\": false}",
    "allowedOrigins": "[\\"https://example.com\\", \\"https://api.example.com\\"]"
  }
}`;

  // Error suggestions based on common patterns
  const ERROR_SUGGESTIONS: Record<string, string> = {
    'tab': 'YAML requires spaces for indentation, not tabs. Replace tabs with spaces (typically 2 per level).',
    'indent': 'Check that all items at the same level have identical indentation.',
    'colon': 'Keys must be followed by a colon and a space. Format: key: value',
    'duplicate': 'Each key must be unique within its parent mapping. Remove or rename the duplicate.',
    'mapping': 'Expected a key-value pair. Make sure you have proper YAML mapping syntax.',
    'sequence': 'Expected a list item. List items must start with "- " (dash and space).',
    'unexpected': 'Check for unquoted special characters. Values with : @ # & * should be quoted.',
    'anchor': 'Anchor must be defined before it can be referenced. Check your & and * usage.',
    'json': 'Invalid JSON syntax. Check for missing commas, quotes, or brackets.',
    'eof': 'Unexpected end of input. Check for unclosed brackets, braces, or quotes.'
  };

  // ============================================================================
  // DOM ELEMENTS
  // ============================================================================

  var inputEditor = document.getElementById('input-editor') as HTMLTextAreaElement;
  var outputEditor = document.getElementById('output-editor') as HTMLTextAreaElement;
  var inputLineNumbers = document.getElementById('input-line-numbers') as HTMLDivElement;
  var outputLineNumbers = document.getElementById('output-line-numbers') as HTMLDivElement;
  var formatBanner = document.getElementById('format-banner') as HTMLDivElement;
  var formatIndicator = document.getElementById('format-indicator') as HTMLSpanElement;
  var formatYamlBtn = document.getElementById('format-yaml-btn') as HTMLButtonElement;
  var formatJsonBtn = document.getElementById('format-json-btn') as HTMLButtonElement;
  var convertBtn = document.getElementById('convert-btn') as HTMLButtonElement;
  var convertBtnText = document.getElementById('convert-btn-text') as HTMLSpanElement;
  var copyBtn = document.getElementById('copy-btn') as HTMLButtonElement;
  var downloadBtn = document.getElementById('download-btn') as HTMLButtonElement;
  var clearBtn = document.getElementById('clear-btn') as HTMLButtonElement;
  var pasteBtn = document.getElementById('paste-btn') as HTMLButtonElement;
  var sampleYamlBtn = document.getElementById('sample-yaml-btn') as HTMLButtonElement;
  var sampleJsonBtn = document.getElementById('sample-json-btn') as HTMLButtonElement;
  var errorMessage = document.getElementById('error-message') as HTMLDivElement;
  var errorText = document.getElementById('error-text') as HTMLSpanElement;
  var errorLocation = document.getElementById('error-location') as HTMLSpanElement;
  var errorSuggestion = document.getElementById('error-suggestion') as HTMLSpanElement;
  var successMessage = document.getElementById('success-message') as HTMLDivElement;
  var successText = document.getElementById('success-text') as HTMLSpanElement;
  var outputFormatBadge = document.getElementById('output-format-badge') as HTMLSpanElement;
  var statsCard = document.getElementById('stats-card') as HTMLDivElement;
  var statLines = document.getElementById('stat-lines') as HTMLSpanElement;
  var statChars = document.getElementById('stat-chars') as HTMLSpanElement;
  var statKeys = document.getElementById('stat-keys') as HTMLSpanElement;
  var statDepth = document.getElementById('stat-depth') as HTMLSpanElement;
  var optionMinify = document.getElementById('option-minify') as HTMLInputElement;
  var optionIndent = document.getElementById('option-indent') as HTMLInputElement;
  var optionSortKeys = document.getElementById('option-sort-keys') as HTMLInputElement;
  var newsletterForm = document.querySelector('.newsletter-form') as HTMLFormElement | null;
  var newsletterSuccess = document.getElementById('newsletter-success') as HTMLDivElement;

  // ============================================================================
  // STATE
  // ============================================================================

  var currentFormat: 'yaml' | 'json' | null = null;
  var currentData: unknown = null;
  var outputFormat: 'yaml' | 'json' | null = null;

  // ============================================================================
  // UTILITY FUNCTIONS
  // ============================================================================

  /**
   * Debounce function for performance optimization
   */
  function debounce<T extends (...args: unknown[]) => void>(func: T, wait: number): T {
    var timeout: ReturnType<typeof setTimeout>;
    return function(this: unknown, ...args: Parameters<T>) {
      clearTimeout(timeout);
      timeout = setTimeout(() => func.apply(this, args), wait);
    } as T;
  }

  /**
   * Update line numbers for an editor
   */
  function updateLineNumbers(textarea: HTMLTextAreaElement, lineNumbersDiv: HTMLDivElement): void {
    var lines = textarea.value.split('\n');
    var lineCount = lines.length || 1;
    var html = '';
    for (var i = 1; i <= lineCount; i++) {
      html += '<span>' + i + '</span>';
    }
    lineNumbersDiv.innerHTML = html;
  }

  /**
   * Sync scroll position between textarea and line numbers
   */
  function syncScroll(textarea: HTMLTextAreaElement, lineNumbersDiv: HTMLDivElement): void {
    lineNumbersDiv.scrollTop = textarea.scrollTop;
  }

  /**
   * Detect format (YAML vs JSON) from input text
   * Uses multiple heuristics for accurate detection
   */
  function detectFormat(text: string): 'yaml' | 'json' | null {
    var trimmed = text.trim();

    if (!trimmed) {
      return null;
    }

    // Check for JSON-specific patterns first (more strict)
    // JSON must start with { or [
    if (trimmed.startsWith('{') || trimmed.startsWith('[')) {
      // Try to parse as JSON to confirm
      try {
        JSON.parse(trimmed);
        return 'json';
      } catch {
        // Could be invalid JSON or YAML that looks like JSON
        // Check for YAML-specific indicators
        if (hasYamlIndicators(trimmed)) {
          return 'yaml';
        }
        // Assume JSON if it starts with { or [
        return 'json';
      }
    }

    // Check for YAML-specific indicators
    if (hasYamlIndicators(trimmed)) {
      return 'yaml';
    }

    // Check for YAML document markers
    if (trimmed.startsWith('---') || trimmed.startsWith('%YAML')) {
      return 'yaml';
    }

    // Check for YAML-style key: value pairs
    if (/^[a-zA-Z_][a-zA-Z0-9_]*\s*:/.test(trimmed)) {
      return 'yaml';
    }

    // Default to YAML for non-JSON looking content
    return 'yaml';
  }

  /**
   * Check for YAML-specific syntax indicators
   */
  function hasYamlIndicators(text: string): boolean {
    // YAML comments
    if (text.includes('#')) return true;
    // YAML multi-line indicators
    if (/[|>][-+]?\s*$/.test(text)) return true;
    // YAML anchors/aliases
    if (/[&*][a-zA-Z]/.test(text)) return true;
    // YAML document markers
    if (text.includes('---') || text.includes('...')) return true;
    // YAML flow sequences/mappings with newlines
    if (/:\s*\n\s+-/.test(text)) return true;
    return false;
  }

  /**
   * Parse YAML with comprehensive error handling
   * Compliant with YAML 1.2 specification
   */
  function parseYaml(text: string): ParseResult {
    var trimmed = text.trim();

    if (!trimmed) {
      return { valid: false, error: { message: 'Input is empty' } };
    }

    try {
      // Check for tabs (common YAML error)
      if (text.includes('\t')) {
        var tabLine = text.split('\n').findIndex(line => line.includes('\t')) + 1;
        return {
          valid: false,
          error: {
            message: 'YAML does not allow tab characters for indentation',
            line: tabLine,
            suggestion: ERROR_SUGGESTIONS['tab']
          }
        };
      }

      // Parse using js-yaml with safe schema (prevents code execution)
      var data = jsyaml.load(text, {
        schema: jsyaml.DEFAULT_SCHEMA,
        onWarning: function(warning: Error) {
          log.warn('YAML warning:', warning.message);
        }
      });

      return { valid: true, data: data, format: 'yaml' };
    } catch (e: unknown) {
      var error = e as Error & { mark?: { line?: number; column?: number }; reason?: string };
      var parseError: ParseError = {
        message: error.message || 'Invalid YAML syntax'
      };

      // Extract line/column from js-yaml error
      if (error.mark) {
        parseError.line = (error.mark.line ?? 0) + 1; // js-yaml uses 0-based lines
        parseError.column = (error.mark.column ?? 0) + 1;
      }

      if (error.reason) {
        parseError.reason = error.reason;
      }

      // Add helpful suggestion based on error type
      parseError.suggestion = getSuggestionForError(error.message);

      return { valid: false, error: parseError };
    }
  }

  /**
   * Parse JSON with comprehensive error handling
   * Compliant with RFC 8259
   */
  function parseJson(text: string): ParseResult {
    var trimmed = text.trim();

    if (!trimmed) {
      return { valid: false, error: { message: 'Input is empty' } };
    }

    try {
      var data = JSON.parse(trimmed);
      return { valid: true, data: data, format: 'json' };
    } catch (e: unknown) {
      var error = e as SyntaxError;
      var parseError: ParseError = {
        message: error.message || 'Invalid JSON syntax'
      };

      // Try to extract position from error message
      // Different browsers format this differently
      var posMatch = error.message.match(/position\s+(\d+)/i);
      if (posMatch) {
        var position = parseInt(posMatch[1], 10);
        var lineInfo = getLineFromPosition(trimmed, position);
        parseError.line = lineInfo.line;
        parseError.column = lineInfo.column;
      }

      // Extract line number from error message if available
      var lineMatch = error.message.match(/line\s+(\d+)/i);
      if (lineMatch) {
        parseError.line = parseInt(lineMatch[1], 10);
      }

      // Add helpful suggestion
      parseError.suggestion = getSuggestionForJsonError(trimmed, parseError);

      return { valid: false, error: parseError };
    }
  }

  /**
   * Get line and column from character position
   */
  function getLineFromPosition(text: string, position: number): { line: number; column: number } {
    var lines = text.substring(0, position).split('\n');
    return {
      line: lines.length,
      column: lines[lines.length - 1].length + 1
    };
  }

  /**
   * Get suggestion for YAML error
   */
  function getSuggestionForError(message: string): string {
    var lowerMessage = message.toLowerCase();

    for (var [key, suggestion] of Object.entries(ERROR_SUGGESTIONS)) {
      if (lowerMessage.includes(key)) {
        return suggestion;
      }
    }

    // Default suggestions based on common patterns
    if (lowerMessage.includes('expected')) {
      return 'Check the syntax at the indicated line. Make sure colons have spaces after them and lists are properly indented.';
    }

    return 'Check the YAML syntax reference below for correct formatting.';
  }

  /**
   * Get suggestion for JSON error with smart detection
   */
  function getSuggestionForJsonError(text: string, error: ParseError): string {
    var line = error.line;

    if (line) {
      var lines = text.split('\n');
      var errorLine = lines[line - 1] || '';

      // Check for common issues
      if (errorLine.includes("'")) {
        return 'JSON requires double quotes (") not single quotes (\').';
      }
      if (/,\s*[}\]]/.test(errorLine)) {
        return 'Remove the trailing comma before the closing bracket/brace.';
      }
      if (/[}\]]\s*[^,\s]/.test(errorLine)) {
        return 'Missing comma between elements.';
      }
    }

    // Check entire text for common issues
    if (text.includes("'")) {
      return 'JSON requires double quotes (") for strings, not single quotes (\').';
    }
    if (/,\s*[}\]]/.test(text)) {
      return 'Trailing commas are not allowed in JSON. Remove the comma before } or ].';
    }
    if (text.includes('//') || text.includes('/*')) {
      return 'JSON does not support comments. Remove // or /* */ comments.';
    }
    if (/\bundefined\b/.test(text)) {
      return 'JSON does not support undefined. Use null instead.';
    }
    if (/:\s*'/.test(text)) {
      return 'JSON values must use double quotes for strings.';
    }

    return ERROR_SUGGESTIONS['json'];
  }

  /**
   * Convert data to YAML format
   */
  function toYaml(data: unknown, options: { indent?: number; sortKeys?: boolean; minify?: boolean } = {}): string {
    var indent = options.indent ?? parseInt(optionIndent.value, 10) || 2;
    var sortKeys = options.sortKeys ?? optionSortKeys.checked;

    if (options.minify) {
      // For YAML, "minify" means flow style (inline)
      return jsyaml.dump(data, {
        flowLevel: 0,
        sortKeys: sortKeys,
        lineWidth: -1
      });
    }

    return jsyaml.dump(data, {
      indent: indent,
      lineWidth: 120,
      sortKeys: sortKeys,
      quotingType: '"',
      forceQuotes: false
    });
  }

  /**
   * Convert data to JSON format
   */
  function toJson(data: unknown, options: { indent?: number; sortKeys?: boolean; minify?: boolean } = {}): string {
    var indent = options.minify ? 0 : (options.indent ?? parseInt(optionIndent.value, 10) || 2);
    var sortKeys = options.sortKeys ?? optionSortKeys.checked;

    if (sortKeys && data && typeof data === 'object') {
      data = sortObjectKeys(data);
    }

    return JSON.stringify(data, null, indent);
  }

  /**
   * Recursively sort object keys
   */
  function sortObjectKeys(obj: unknown): unknown {
    if (Array.isArray(obj)) {
      return obj.map(sortObjectKeys);
    }
    if (obj && typeof obj === 'object' && obj !== null) {
      var sorted: Record<string, unknown> = {};
      var keys = Object.keys(obj as Record<string, unknown>).sort();
      for (var key of keys) {
        sorted[key] = sortObjectKeys((obj as Record<string, unknown>)[key]);
      }
      return sorted;
    }
    return obj;
  }

  /**
   * Calculate document statistics
   */
  function calculateStats(text: string, data: unknown): DocumentStats {
    var lines = text.split('\n').length;
    var characters = text.length;
    var keys = countKeys(data);
    var maxDepth = calculateMaxDepth(data);

    return { lines, characters, keys, maxDepth };
  }

  /**
   * Count total keys in object/array
   */
  function countKeys(data: unknown): number {
    if (data === null || data === undefined) return 0;
    if (typeof data !== 'object') return 0;

    var count = 0;
    if (Array.isArray(data)) {
      for (var item of data) {
        count += countKeys(item);
      }
    } else {
      var keys = Object.keys(data);
      count = keys.length;
      for (var key of keys) {
        count += countKeys((data as Record<string, unknown>)[key]);
      }
    }
    return count;
  }

  /**
   * Calculate maximum nesting depth
   */
  function calculateMaxDepth(data: unknown, currentDepth: number = 0): number {
    if (data === null || data === undefined) return currentDepth;
    if (typeof data !== 'object') return currentDepth;

    var maxChildDepth = currentDepth;
    if (Array.isArray(data)) {
      for (var item of data) {
        maxChildDepth = Math.max(maxChildDepth, calculateMaxDepth(item, currentDepth + 1));
      }
    } else {
      for (var key of Object.keys(data)) {
        maxChildDepth = Math.max(maxChildDepth, calculateMaxDepth((data as Record<string, unknown>)[key], currentDepth + 1));
      }
    }
    return maxChildDepth;
  }

  /**
   * Copy text to clipboard
   */
  async function copyToClipboard(text: string): Promise<boolean> {
    try {
      await navigator.clipboard.writeText(text);
      return true;
    } catch (err) {
      // Fallback for older browsers
      var textarea = document.createElement('textarea');
      textarea.value = text;
      textarea.style.position = 'fixed';
      textarea.style.left = '-9999px';
      document.body.appendChild(textarea);
      textarea.select();
      try {
        document.execCommand('copy');
        return true;
      } catch {
        return false;
      } finally {
        document.body.removeChild(textarea);
      }
    }
  }

  /**
   * Download text as file
   */
  function downloadFile(text: string, filename: string, mimeType: string): void {
    var blob = new Blob([text], { type: mimeType });
    var url = URL.createObjectURL(blob);
    var a = document.createElement('a');
    a.href = url;
    a.download = filename;
    document.body.appendChild(a);
    a.click();
    document.body.removeChild(a);
    URL.revokeObjectURL(url);
  }

  // ============================================================================
  // UI UPDATE FUNCTIONS
  // ============================================================================

  /**
   * Update format indicator
   */
  function updateFormatIndicator(format: 'yaml' | 'json' | null): void {
    currentFormat = format;

    if (format === 'yaml') {
      formatIndicator.innerHTML = '<span class="format-icon yaml">Y</span><span class="format-text">Detected: YAML</span>';
      formatIndicator.className = 'format-indicator yaml';
      formatYamlBtn.textContent = 'Format YAML';
      formatJsonBtn.textContent = 'Convert to JSON';
      convertBtnText.textContent = 'Convert to JSON';
    } else if (format === 'json') {
      formatIndicator.innerHTML = '<span class="format-icon json">J</span><span class="format-text">Detected: JSON</span>';
      formatIndicator.className = 'format-indicator json';
      formatYamlBtn.textContent = 'Convert to YAML';
      formatJsonBtn.textContent = 'Format JSON';
      convertBtnText.textContent = 'Convert to YAML';
    } else {
      formatIndicator.innerHTML = '<span class="format-icon">?</span><span class="format-text">Paste content to detect format</span>';
      formatIndicator.className = 'format-indicator';
    }
  }

  /**
   * Show error message
   */
  function showError(error: ParseError): void {
    errorText.textContent = error.message;

    if (error.line) {
      var locationText = 'Line ' + error.line;
      if (error.column) {
        locationText += ', Column ' + error.column;
      }
      errorLocation.textContent = locationText;
      errorLocation.classList.remove('hidden');
    } else {
      errorLocation.classList.add('hidden');
    }

    if (error.suggestion) {
      errorSuggestion.textContent = error.suggestion;
      errorSuggestion.classList.remove('hidden');
    } else {
      errorSuggestion.classList.add('hidden');
    }

    errorMessage.classList.remove('hidden');
    successMessage.classList.add('hidden');

    // Highlight error line in input
    if (error.line) {
      highlightErrorLine(error.line);
    }
  }

  /**
   * Show success message
   */
  function showSuccess(message: string = 'Valid!'): void {
    successText.textContent = message;
    successMessage.classList.remove('hidden');
    errorMessage.classList.add('hidden');
    clearErrorHighlight();
  }

  /**
   * Hide all messages
   */
  function hideMessages(): void {
    errorMessage.classList.add('hidden');
    successMessage.classList.add('hidden');
    clearErrorHighlight();
  }

  /**
   * Highlight error line in input editor
   */
  function highlightErrorLine(line: number): void {
    var lineSpans = inputLineNumbers.querySelectorAll('span');
    lineSpans.forEach(function(span, index) {
      if (index + 1 === line) {
        span.classList.add('error-line');
      } else {
        span.classList.remove('error-line');
      }
    });
  }

  /**
   * Clear error line highlight
   */
  function clearErrorHighlight(): void {
    var lineSpans = inputLineNumbers.querySelectorAll('span');
    lineSpans.forEach(function(span) {
      span.classList.remove('error-line');
    });
  }

  /**
   * Update output editor
   */
  function updateOutput(text: string, format: 'yaml' | 'json'): void {
    outputEditor.value = text;
    outputFormat = format;
    updateLineNumbers(outputEditor, outputLineNumbers);

    // Update output format badge
    outputFormatBadge.textContent = format.toUpperCase();
    outputFormatBadge.className = 'output-format-badge ' + format;
    outputFormatBadge.classList.remove('hidden');

    // Enable output actions
    copyBtn.disabled = false;
    downloadBtn.disabled = false;
  }

  /**
   * Clear output
   */
  function clearOutput(): void {
    outputEditor.value = '';
    outputFormat = null;
    updateLineNumbers(outputEditor, outputLineNumbers);
    outputFormatBadge.classList.add('hidden');
    copyBtn.disabled = true;
    downloadBtn.disabled = true;
  }

  /**
   * Update statistics display
   */
  function updateStats(stats: DocumentStats): void {
    statLines.textContent = stats.lines.toString();
    statChars.textContent = formatNumber(stats.characters);
    statKeys.textContent = stats.keys.toString();
    statDepth.textContent = stats.maxDepth.toString();
    statsCard.classList.remove('hidden');
  }

  /**
   * Format number with commas
   */
  function formatNumber(num: number): string {
    return num.toLocaleString();
  }

  /**
   * Hide statistics
   */
  function hideStats(): void {
    statsCard.classList.add('hidden');
  }

  // ============================================================================
  // EVENT HANDLERS
  // ============================================================================

  /**
   * Handle input change
   */
  function handleInputChange(): void {
    var text = inputEditor.value;
    updateLineNumbers(inputEditor, inputLineNumbers);

    if (!text.trim()) {
      updateFormatIndicator(null);
      hideMessages();
      clearOutput();
      hideStats();
      formatYamlBtn.disabled = true;
      formatJsonBtn.disabled = true;
      convertBtn.disabled = true;
      currentData = null;
      return;
    }

    // Detect format
    var format = detectFormat(text);
    updateFormatIndicator(format);

    // Parse based on detected format
    var result: ParseResult;
    if (format === 'json') {
      result = parseJson(text);
    } else {
      result = parseYaml(text);
    }

    if (result.valid) {
      currentData = result.data;
      showSuccess(format === 'yaml' ? 'Valid YAML' : 'Valid JSON');
      formatYamlBtn.disabled = false;
      formatJsonBtn.disabled = false;
      convertBtn.disabled = false;

      // Calculate and show stats
      var stats = calculateStats(text, result.data);
      updateStats(stats);
    } else {
      currentData = null;
      if (result.error) {
        showError(result.error);
      }
      formatYamlBtn.disabled = true;
      formatJsonBtn.disabled = true;
      convertBtn.disabled = true;
      hideStats();
    }
  }

  /**
   * Handle convert button click
   */
  function handleConvert(): void {
    if (currentData === undefined || currentData === null) {
      return;
    }

    var options = {
      indent: parseInt(optionIndent.value, 10) || 2,
      sortKeys: optionSortKeys.checked,
      minify: optionMinify.checked
    };

    if (currentFormat === 'yaml') {
      // Convert to JSON
      var jsonOutput = toJson(currentData, options);
      updateOutput(jsonOutput, 'json');
    } else {
      // Convert to YAML
      var yamlOutput = toYaml(currentData, options);
      updateOutput(yamlOutput, 'yaml');
    }
  }

  /**
   * Handle format as YAML button
   */
  function handleFormatYaml(): void {
    if (currentData === undefined || currentData === null) {
      return;
    }

    var options = {
      indent: parseInt(optionIndent.value, 10) || 2,
      sortKeys: optionSortKeys.checked,
      minify: optionMinify.checked
    };

    var yamlOutput = toYaml(currentData, options);
    updateOutput(yamlOutput, 'yaml');
  }

  /**
   * Handle format as JSON button
   */
  function handleFormatJson(): void {
    if (currentData === undefined || currentData === null) {
      return;
    }

    var options = {
      indent: parseInt(optionIndent.value, 10) || 2,
      sortKeys: optionSortKeys.checked,
      minify: optionMinify.checked
    };

    var jsonOutput = toJson(currentData, options);
    updateOutput(jsonOutput, 'json');
  }

  /**
   * Handle copy button
   */
  async function handleCopy(): Promise<void> {
    var text = outputEditor.value;
    if (!text) return;

    var success = await copyToClipboard(text);
    if (success) {
      var copyIcon = copyBtn.querySelector('.copy-icon') as SVGElement;
      var checkIcon = copyBtn.querySelector('.check-icon') as SVGElement;

      copyIcon.classList.add('hidden');
      checkIcon.classList.remove('hidden');

      setTimeout(function() {
        copyIcon.classList.remove('hidden');
        checkIcon.classList.add('hidden');
      }, 2000);
    }
  }

  /**
   * Handle download button
   */
  function handleDownload(): void {
    var text = outputEditor.value;
    if (!text || !outputFormat) return;

    var extension = outputFormat === 'yaml' ? 'yaml' : 'json';
    var mimeType = outputFormat === 'yaml' ? 'text/yaml' : 'application/json';
    var filename = 'converted.' + extension;

    downloadFile(text, filename, mimeType);
  }

  /**
   * Handle clear button
   */
  function handleClear(): void {
    inputEditor.value = '';
    handleInputChange();
    clearOutput();
    inputEditor.focus();
  }

  /**
   * Handle paste button
   */
  async function handlePaste(): Promise<void> {
    try {
      var text = await navigator.clipboard.readText();
      inputEditor.value = text;
      handleInputChange();
    } catch (err) {
      log.error('Failed to read clipboard:', err);
    }
  }

  /**
   * Handle sample YAML button
   */
  function handleSampleYaml(): void {
    inputEditor.value = SAMPLE_YAML;
    handleInputChange();
  }

  /**
   * Handle sample JSON button
   */
  function handleSampleJson(): void {
    inputEditor.value = SAMPLE_JSON;
    handleInputChange();
  }

  /**
   * Handle newsletter form submission
   */
  function handleNewsletterSubmit(e: Event): void {
    e.preventDefault();
    var form = e.target as HTMLFormElement;
    var formData = new FormData(form);

    // Check honeypot
    var honeypotFields = form.querySelectorAll('.honeypot-field') as NodeListOf<HTMLInputElement>;
    var isBot = false;
    honeypotFields.forEach(function(field) {
      if (field.value !== '') {
        isBot = true;
      }
    });

    if (isBot) {
      return;
    }

    fetch(form.action, {
      method: 'POST',
      body: formData
    }).then(function(response) {
      if (response.ok) {
        form.classList.add('hidden');
        newsletterSuccess.classList.remove('hidden');
      }
    }).catch(function(err) {
      log.error('Newsletter error:', err);
    });
  }

  // ============================================================================
  // INITIALIZATION
  // ============================================================================

  function init(): void {
    // Initialize line numbers
    updateLineNumbers(inputEditor, inputLineNumbers);
    updateLineNumbers(outputEditor, outputLineNumbers);

    // Input handlers
    var debouncedInputChange = debounce(handleInputChange, 300);
    inputEditor.addEventListener('input', debouncedInputChange);
    inputEditor.addEventListener('scroll', function() {
      syncScroll(inputEditor, inputLineNumbers);
    });

    outputEditor.addEventListener('scroll', function() {
      syncScroll(outputEditor, outputLineNumbers);
    });

    // Action buttons
    convertBtn.addEventListener('click', handleConvert);
    formatYamlBtn.addEventListener('click', handleFormatYaml);
    formatJsonBtn.addEventListener('click', handleFormatJson);
    copyBtn.addEventListener('click', handleCopy);
    downloadBtn.addEventListener('click', handleDownload);
    clearBtn.addEventListener('click', handleClear);
    pasteBtn.addEventListener('click', handlePaste);
    sampleYamlBtn.addEventListener('click', handleSampleYaml);
    sampleJsonBtn.addEventListener('click', handleSampleJson);

    // Option changes trigger re-conversion if output exists
    optionMinify.addEventListener('change', function() {
      if (outputEditor.value && currentData !== null) {
        handleConvert();
      }
    });
    optionIndent.addEventListener('change', function() {
      if (outputEditor.value && currentData !== null) {
        handleConvert();
      }
    });
    optionSortKeys.addEventListener('change', function() {
      if (outputEditor.value && currentData !== null) {
        handleConvert();
      }
    });

    // Newsletter form
    if (newsletterForm) {
      newsletterForm.addEventListener('submit', handleNewsletterSubmit);
    }

    // Check for URL params (for shareable links)
    var params = new URLSearchParams(window.location.search);
    var inputParam = params.get('input');
    if (inputParam) {
      try {
        inputEditor.value = atob(inputParam);
        handleInputChange();
      } catch (e) {
        log.error('Failed to decode input param:', e);
      }
    }

    // Focus input on load
    inputEditor.focus();
  }

  // Run on DOM ready and Astro page loads
  document.addEventListener('DOMContentLoaded', init, { once: true });
  document.addEventListener('astro:page-load', init, { once: true });
</script>

<style scoped>
  /* Format Banner */
  .format-banner {
    display: flex;
    justify-content: space-between;
    align-items: center;
    flex-wrap: wrap;
    gap: var(--space-sm);
    margin-bottom: var(--space-lg);
    padding: var(--space-sm) var(--space-md);
    background: var(--color-bg);
    border-radius: var(--border-radius-sm);
    border: 1px solid var(--color-border);
  }

  .format-indicator {
    display: flex;
    align-items: center;
    gap: var(--space-xs);
    font-size: 0.9375rem;
    color: var(--color-text-muted);
  }

  .format-icon {
    display: flex;
    align-items: center;
    justify-content: center;
    width: 24px;
    height: 24px;
    background: var(--color-bg-elevated);
    border-radius: 4px;
    font-size: 0.75rem;
    font-weight: 600;
    color: var(--color-text-dim);
  }

  .format-indicator.yaml .format-icon {
    background: rgba(34, 197, 94, 0.15);
    color: #22c55e;
  }

  .format-indicator.json .format-icon {
    background: rgba(59, 130, 246, 0.15);
    color: #3b82f6;
  }

  .format-actions {
    display: flex;
    gap: var(--space-xs);
  }

  .action-chip {
    padding: 0.375rem 0.75rem;
    font-size: 0.8125rem;
    font-weight: 500;
    background: transparent;
    border: 1px solid var(--color-border);
    border-radius: 999px;
    color: var(--color-text-muted);
    cursor: pointer;
    transition: all var(--transition-fast);
    font-family: inherit;
  }

  .action-chip:hover:not(:disabled) {
    border-color: var(--color-accent);
    color: var(--color-accent-light);
  }

  .action-chip:disabled {
    opacity: 0.5;
    cursor: not-allowed;
  }

  /* Editor Section */
  .editor-section {
    display: grid;
    grid-template-columns: 1fr auto 1fr;
    gap: var(--space-md);
    margin-bottom: var(--space-lg);
  }

  @media (max-width: 900px) {
    .editor-section {
      grid-template-columns: 1fr;
    }
  }

  .editor-pane {
    display: flex;
    flex-direction: column;
    min-width: 0;
  }

  .editor-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: var(--space-xs);
  }

  .editor-label {
    display: flex;
    align-items: center;
    gap: var(--space-xs);
    font-size: 0.875rem;
    font-weight: 500;
    color: var(--color-text-muted);
  }

  .output-format-badge {
    padding: 0.125rem 0.5rem;
    font-size: 0.6875rem;
    font-weight: 600;
    text-transform: uppercase;
    letter-spacing: 0.05em;
    border-radius: 4px;
    background: var(--color-bg-elevated);
    color: var(--color-text-dim);
  }

  .output-format-badge.yaml {
    background: rgba(34, 197, 94, 0.15);
    color: #22c55e;
  }

  .output-format-badge.json {
    background: rgba(59, 130, 246, 0.15);
    color: #3b82f6;
  }

  .editor-actions {
    display: flex;
    gap: 4px;
  }

  .icon-btn {
    display: flex;
    align-items: center;
    justify-content: center;
    width: 32px;
    height: 32px;
    background: transparent;
    border: 1px solid transparent;
    border-radius: 6px;
    color: var(--color-text-dim);
    cursor: pointer;
    transition: all var(--transition-fast);
    font-family: var(--font-mono);
    font-size: 0.6875rem;
    font-weight: 500;
  }

  .icon-btn:hover:not(:disabled) {
    border-color: var(--color-border);
    color: var(--color-text);
    background: var(--color-bg-elevated);
  }

  .icon-btn:disabled {
    opacity: 0.4;
    cursor: not-allowed;
  }

  .editor-wrapper {
    display: flex;
    position: relative;
    background: var(--color-bg);
    border: 2px solid var(--color-border);
    border-radius: var(--border-radius-sm);
    overflow: hidden;
  }

  .editor-wrapper:focus-within {
    border-color: var(--color-accent);
    box-shadow: 0 0 0 4px rgba(59, 130, 246, 0.15);
  }

  .line-numbers {
    display: flex;
    flex-direction: column;
    padding: var(--space-sm) var(--space-xs);
    background: var(--color-bg-elevated);
    border-right: 1px solid var(--color-border);
    font-family: var(--font-mono);
    font-size: 0.8125rem;
    line-height: 1.5;
    color: var(--color-text-dim);
    text-align: right;
    user-select: none;
    min-width: 40px;
    overflow: hidden;
  }

  .line-numbers span {
    padding: 0 var(--space-xs);
  }

  .line-numbers span.error-line {
    background: rgba(239, 68, 68, 0.2);
    color: #fca5a5;
  }

  .editor-textarea {
    flex: 1;
    min-height: 300px;
    padding: var(--space-sm);
    font-family: var(--font-mono);
    font-size: 0.875rem;
    line-height: 1.5;
    background: transparent;
    border: none;
    color: var(--color-text);
    resize: vertical;
    overflow: auto;
  }

  .editor-textarea:focus {
    outline: none;
  }

  .editor-textarea::placeholder {
    color: var(--color-text-dim);
    white-space: pre-line;
  }

  /* Action Buttons */
  .action-buttons {
    display: flex;
    flex-direction: column;
    justify-content: center;
    gap: var(--space-sm);
    padding: var(--space-md) 0;
  }

  @media (max-width: 900px) {
    .action-buttons {
      flex-direction: row;
      justify-content: center;
      padding: var(--space-sm) 0;
    }
  }

  .action-buttons .btn {
    display: flex;
    align-items: center;
    gap: var(--space-xs);
    white-space: nowrap;
  }

  .action-buttons .btn:disabled {
    opacity: 0.5;
    cursor: not-allowed;
  }

  /* Messages */
  .message-area {
    margin-top: var(--space-sm);
    min-height: 40px;
  }

  .error-message,
  .success-message {
    display: flex;
    align-items: flex-start;
    gap: var(--space-sm);
    padding: var(--space-sm) var(--space-md);
    border-radius: var(--border-radius-sm);
    font-size: 0.875rem;
  }

  .error-message {
    background: rgba(239, 68, 68, 0.1);
    border: 1px solid rgba(239, 68, 68, 0.3);
    color: #fca5a5;
  }

  .success-message {
    background: rgba(34, 197, 94, 0.1);
    border: 1px solid rgba(34, 197, 94, 0.3);
    color: #86efac;
  }

  .message-icon {
    flex-shrink: 0;
    margin-top: 2px;
  }

  .message-content {
    display: flex;
    flex-direction: column;
    gap: 4px;
  }

  .message-text {
    font-weight: 500;
  }

  .message-location {
    font-family: var(--font-mono);
    font-size: 0.8125rem;
    color: #fca5a5;
  }

  .message-suggestion {
    font-size: 0.8125rem;
    color: var(--color-text-muted);
    font-style: italic;
  }

  /* Options Section */
  .options-section {
    padding-top: var(--space-md);
    border-top: 1px solid var(--color-border);
  }

  .option-group {
    display: flex;
    flex-wrap: wrap;
    gap: var(--space-md);
  }

  .option-label {
    display: flex;
    align-items: center;
    gap: var(--space-xs);
    font-size: 0.875rem;
    color: var(--color-text-muted);
    cursor: pointer;
  }

  .option-label input[type="checkbox"] {
    width: 16px;
    height: 16px;
    cursor: pointer;
  }

  .option-label input[type="number"] {
    width: 50px;
    padding: 0.25rem 0.5rem;
    font-size: 0.875rem;
    text-align: center;
  }

  /* Stats Card */
  .stats-card h2 {
    font-size: 1.125rem;
    margin-bottom: var(--space-md);
  }

  .stats-grid {
    display: grid;
    grid-template-columns: repeat(4, 1fr);
    gap: var(--space-md);
  }

  @media (max-width: 600px) {
    .stats-grid {
      grid-template-columns: repeat(2, 1fr);
    }
  }

  .stat-item {
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: 4px;
    padding: var(--space-sm);
    background: var(--color-bg);
    border-radius: var(--border-radius-sm);
  }

  .stat-value {
    font-size: 1.5rem;
    font-weight: 600;
    color: var(--color-accent-light);
    font-family: var(--font-mono);
  }

  .stat-label {
    font-size: 0.75rem;
    color: var(--color-text-dim);
    text-transform: uppercase;
    letter-spacing: 0.05em;
  }

  /* Reference Section */
  .reference-section h2 {
    font-size: 1.25rem;
    margin-bottom: var(--space-sm);
  }

  .section-intro {
    color: var(--color-text-muted);
    font-size: 0.9375rem;
    margin-bottom: var(--space-lg);
  }

  .reference-table-wrapper {
    overflow-x: auto;
  }

  .reference-table {
    width: 100%;
    border-collapse: collapse;
    font-size: 0.875rem;
  }

  .reference-table th,
  .reference-table td {
    padding: var(--space-sm);
    text-align: left;
    border-bottom: 1px solid var(--color-border);
  }

  .reference-table th {
    color: var(--color-text-dim);
    font-weight: 500;
    font-size: 0.8125rem;
    text-transform: uppercase;
    letter-spacing: 0.05em;
  }

  .reference-table td {
    color: var(--color-text-muted);
  }

  .reference-table code {
    font-family: var(--font-mono);
    color: var(--color-accent-light);
    background: var(--color-bg);
    padding: 0.125rem 0.375rem;
    border-radius: 4px;
  }

  .example-code {
    white-space: pre;
    font-size: 0.75rem;
  }

  /* Errors Section */
  .errors-section h2 {
    font-size: 1.25rem;
    margin-bottom: var(--space-lg);
  }

  .errors-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
    gap: var(--space-md);
  }

  .error-card {
    padding: var(--space-md);
    background: var(--color-bg);
    border-radius: var(--border-radius-sm);
    border: 1px solid var(--color-border);
  }

  .error-card h3 {
    font-size: 1rem;
    margin-bottom: var(--space-xs);
    color: var(--color-text);
  }

  .error-description {
    font-size: 0.875rem;
    color: var(--color-text-muted);
    margin-bottom: var(--space-sm);
  }

  .error-fix {
    font-size: 0.8125rem;
    color: var(--color-text-dim);
    margin: 0;
  }

  .error-fix strong {
    color: var(--color-success);
  }

  /* FAQ Section */
  .faq-section h2 {
    font-size: 1.25rem;
    margin-bottom: var(--space-lg);
  }

  .faq-item {
    border-bottom: 1px solid var(--color-border);
  }

  .faq-item summary {
    padding: var(--space-md) 0;
    font-weight: 500;
    color: var(--color-text);
    cursor: pointer;
    list-style: none;
    display: flex;
    justify-content: space-between;
    align-items: center;
  }

  .faq-item summary::after {
    content: '+';
    font-size: 1.25rem;
    color: var(--color-text-muted);
    transition: transform var(--transition-fast);
  }

  .faq-item[open] summary::after {
    content: '-';
  }

  .faq-item p,
  .faq-item ul {
    padding-bottom: var(--space-md);
    color: var(--color-text-muted);
    font-size: 0.9375rem;
    line-height: 1.6;
  }

  .faq-item ul {
    padding-left: var(--space-lg);
    margin: 0;
  }

  .faq-item li {
    margin-bottom: var(--space-xs);
  }

  /* Newsletter Section */
  .newsletter-section {
    text-align: center;
  }

  .newsletter-section h2 {
    font-size: 1.5rem;
    margin-bottom: var(--space-sm);
  }

  .newsletter-section > p {
    color: var(--color-text-muted);
    margin-bottom: var(--space-lg);
  }

  .form-row {
    display: flex;
    gap: var(--space-sm);
    max-width: 500px;
    margin: 0 auto var(--space-sm);
  }

  .email-input {
    flex: 1;
  }

  .altcha-widget {
    display: none;
  }

  .form-note {
    font-size: 0.875rem;
    color: var(--color-text-dim);
    margin: 0;
  }

  .honeypot-field {
    position: absolute;
    left: -9999px;
    width: 1px;
    height: 1px;
    opacity: 0;
  }

  .success-message-newsletter {
    padding: var(--space-xl);
    color: var(--color-success);
  }

  .success-message-newsletter h3 {
    margin: var(--space-md) 0 var(--space-sm);
    font-size: 1.25rem;
  }

  .success-message-newsletter p {
    color: var(--color-text-muted);
    margin: 0;
  }

  /* Responsive */
  @media (max-width: 768px) {
    .format-banner {
      flex-direction: column;
      align-items: flex-start;
    }

    .editor-textarea {
      min-height: 200px;
    }

    .form-row {
      flex-direction: column;
    }
  }

  .hidden {
    display: none !important;
  }
</style>
